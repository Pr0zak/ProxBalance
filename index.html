<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>ProxBalance - Cluster Optimization</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg viewBox='0 0 64 64' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cfilter id='glow'%3E%3CfeGaussianBlur stdDeviation='2' result='coloredBlur'/%3E%3CfeMerge%3E%3CfeMergeNode in='coloredBlur'/%3E%3CfeMergeNode in='SourceGraphic'/%3E%3C/feMerge%3E%3C/filter%3E%3C/defs%3E%3Crect width='64' height='64' rx='12' fill='%230f172a'/%3E%3Ccircle cx='32' cy='32' r='8' fill='%23f97316' opacity='0.3'/%3E%3Ccircle cx='32' cy='32' r='5' fill='%23f97316' filter='url(%23glow)'/%3E%3Crect x='20' y='18' width='10' height='10' rx='2' fill='%2306b6d4' opacity='0.2'/%3E%3Crect x='20' y='18' width='10' height='10' rx='2' fill='none' stroke='%2306b6d4' stroke-width='2' filter='url(%23glow)'/%3E%3Crect x='34' y='20' width='10' height='10' rx='2' fill='%2310b981' opacity='0.2'/%3E%3Crect x='34' y='20' width='10' height='10' rx='2' fill='none' stroke='%2310b981' stroke-width='2' filter='url(%23glow)'/%3E%3Cline x1='25' y1='28' x2='25' y2='30' stroke='%2306b6d4' stroke-width='2' filter='url(%23glow)'/%3E%3Cline x1='39' y1='30' x2='39' y2='32' stroke='%2310b981' stroke-width='2' filter='url(%23glow)'/%3E%3Crect x='16' y='30' width='32' height='2' fill='%23f97316' opacity='0.5' filter='url(%23glow)'/%3E%3C/svg%3E">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script>
      tailwind.config = {
        darkMode: 'class'
      }
    </script>
    <style>
      @keyframes dashFlow {
        from { stroke-dashoffset: 0; }
        to { stroke-dashoffset: 10; }
      }
      .animated-arrow {
        animation: dashFlow 1s linear infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      .pulse-animation {
        animation: pulse 2s ease-in-out infinite;
      }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const AlertCircle = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>);
        const Server = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><rect x="2" y="2" width="20" height="8" rx="2"></rect><rect x="2" y="14" width="20" height="8" rx="2"></rect></svg>);
        const HardDrive = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><line x1="22" y1="12" x2="2" y2="12"></line><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path></svg>);
        const Activity = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>);
        const RefreshCw = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>);
        const Play = ({ size }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>);
        const CheckCircle = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>);
        const XCircle = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>);
        const Tag = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>);
        const AlertTriangle = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>);
        const Shield = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>);
        const Clock = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>);
        const Sun = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>);
        const Moon = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>);
        const Settings = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>);
        const X = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        const Save = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>);
        const ChevronDown = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><polyline points="6 9 12 15 18 9"></polyline></svg>);
        const ChevronUp = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><polyline points="18 15 12 9 6 15"></polyline></svg>);
        const GitHub = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="currentColor" className={className}><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>);
        const GitBranch = ({ size, className }) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className={className}><line x1="6" y1="3" x2="6" y2="15"></line><circle cx="18" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><path d="M18 9a9 9 0 0 1-9 9"></path></svg>);

// Logo component
const ProxBalanceLogo = ({ size = 32 }) => (
  <svg width={size} height={size} viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <filter id="logo-glow">
        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
        <feMerge>
          <feMergeNode in="coloredBlur"/>
          <feMergeNode in="SourceGraphic"/>
        </feMerge>
      </filter>
    </defs>
    ✅ (dark background rect removed - now transparent)
    <circle cx="32" cy="32" r="8" fill="#f97316" opacity="0.3"/>
    <circle cx="32" cy="32" r="5" fill="#f97316" filter="url(#logo-glow)"/>
    <rect x="20" y="18" width="10" height="10" rx="2" fill="#06b6d4" opacity="0.2"/>
    <rect x="20" y="18" width="10" height="10" rx="2" fill="none" stroke="#06b6d4" strokeWidth="2" filter="url(#logo-glow)"/>
    <rect x="34" y="20" width="10" height="10" rx="2" fill="#10b981" opacity="0.2"/>
    <rect x="34" y="20" width="10" height="10" rx="2" fill="none" stroke="#10b981" strokeWidth="2" filter="url(#logo-glow)"/>
    <line x1="25" y1="28" x2="25" y2="30" stroke="#06b6d4" strokeWidth="2" filter="url(#logo-glow)"/>
    <line x1="39" y1="30" x2="39" y2="32" stroke="#10b981" strokeWidth="2" filter="url(#logo-glow)"/>
    <rect x="16" y="30" width="32" height="2" fill="#f97316" opacity="0.5" filter="url(#logo-glow)"/>
  </svg>
);

        const API_BASE = `/api`;

        const ProxmoxBalanceManager = () => {
          const [data, setData] = useState(null);
          const [recommendations, setRecommendations] = useState([]);
          const [aiRecommendations, setAiRecommendations] = useState(null);
          const [loadingAi, setLoadingAi] = useState(false);
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState(null);
          const [cpuThreshold, setCpuThreshold] = useState(60);
          const [memThreshold, setMemThreshold] = useState(70);
          const [migrationStatus, setMigrationStatus] = useState({});
          const [lastUpdate, setLastUpdate] = useState(null);
          const [nextUpdate, setNextUpdate] = useState(null);
          const [backendCollected, setBackendCollected] = useState(null);
          const [darkMode, setDarkMode] = useState(true);
          const [config, setConfig] = useState(null);
          const [autoRefreshInterval, setAutoRefreshInterval] = useState(60 * 60 * 1000);
          const [showSettings, setShowSettings] = useState(false);
          const [tempBackendInterval, setTempBackendInterval] = useState(60);
          const [tempUiInterval, setTempUiInterval] = useState(60);
          const [savingSettings, setSavingSettings] = useState(false);
          const [aiProvider, setAiProvider] = useState('none');
          const [aiEnabled, setAiEnabled] = useState(false);
          const [openaiKey, setOpenaiKey] = useState('');
          const [openaiModel, setOpenaiModel] = useState('gpt-4o');
          const [openaiModelCustom, setOpenaiModelCustom] = useState('');
          const [openaiAvailableModels, setOpenaiAvailableModels] = useState([]);
          const [openaiLoadingModels, setOpenaiLoadingModels] = useState(false);
          const [anthropicKey, setAnthropicKey] = useState('');
          const [anthropicModel, setAnthropicModel] = useState('claude-3-5-sonnet-20241022');
          const [anthropicModelCustom, setAnthropicModelCustom] = useState('');
          const [anthropicAvailableModels, setAnthropicAvailableModels] = useState([]);
          const [anthropicLoadingModels, setAnthropicLoadingModels] = useState(false);
          const [localUrl, setLocalUrl] = useState('http://localhost:11434');
          const [localModel, setLocalModel] = useState('llama2');
          const [localModelCustom, setLocalModelCustom] = useState('');
          const [localAvailableModels, setLocalAvailableModels] = useState([]);
          const [localLoadingModels, setLocalLoadingModels] = useState(false);
          const [systemInfo, setSystemInfo] = useState(null);
          const [updating, setUpdating] = useState(false);
          const [updateLog, setUpdateLog] = useState([]);
          const [chartPeriod, setChartPeriod] = useState('1h');
          const [charts, setCharts] = useState({});
          const [showUpdateModal, setShowUpdateModal] = useState(false);
          const [aiAnalysisPeriod, setAiAnalysisPeriod] = useState('24h');
          const [proxmoxTokenId, setProxmoxTokenId] = useState('');
          const [proxmoxTokenSecret, setProxmoxTokenSecret] = useState('');
          const [showBranchModal, setShowBranchModal] = useState(false);
          const [availableBranches, setAvailableBranches] = useState([]);
          const [loadingBranches, setLoadingBranches] = useState(false);
          const [switchingBranch, setSwitchingBranch] = useState(false);

          // Node grid layout state with localStorage persistence
          const [nodeGridColumns, setNodeGridColumns] = useState(() => {
            const saved = localStorage.getItem('nodeGridColumns');
            return saved ? parseInt(saved) : 3;
          });

          // Collapsed sections state with localStorage persistence
          const [collapsedSections, setCollapsedSections] = useState(() => {
            const saved = localStorage.getItem('collapsedSections');
            return saved ? JSON.parse(saved) : {
              clusterMap: false,
              nodeStatus: true,
              recommendations: false,
              aiRecommendations: false,
              taggedGuests: true
            };
          });

          // Save collapsed state to localStorage whenever it changes
          useEffect(() => {
            localStorage.setItem('collapsedSections', JSON.stringify(collapsedSections));
          }, [collapsedSections]);

          // Save node grid columns to localStorage whenever it changes
          useEffect(() => {
            localStorage.setItem('nodeGridColumns', nodeGridColumns.toString());
          }, [nodeGridColumns]);

          const toggleSection = (section) => {
            setCollapsedSections(prev => ({
              ...prev,
              [section]: !prev[section]
            }));
          };

          useEffect(() => {
            document.documentElement.classList.add('dark');
            fetchConfig();
            fetchSystemInfo();
          }, []);

          const fetchConfig = async () => {
            try {
              const response = await fetch(`${API_BASE}/config`);
              const result = await response.json();
              if (result.success) {
                setConfig(result.config);
                const intervalMs = (result.config.ui_refresh_interval_minutes || 60) * 60 * 1000;
                setAutoRefreshInterval(intervalMs);
                setTempBackendInterval(result.config.collection_interval_minutes || 60);
                setTempUiInterval(result.config.ui_refresh_interval_minutes || 60);

                // Load Proxmox API settings
                setProxmoxTokenId(result.config.proxmox_api_token_id || '');
                setProxmoxTokenSecret(result.config.proxmox_api_token_secret || '');

                // Load AI settings
                setAiProvider(result.config.ai_provider || 'none');
                setAiEnabled(result.config.ai_recommendations_enabled || false);
                if (result.config.ai_config) {
                  if (result.config.ai_config.openai) {
                    setOpenaiKey(result.config.ai_config.openai.api_key || '');
                    setOpenaiModel(result.config.ai_config.openai.model || 'gpt-4o');
                  }
                  if (result.config.ai_config.anthropic) {
                    setAnthropicKey(result.config.ai_config.anthropic.api_key || '');
                    setAnthropicModel(result.config.ai_config.anthropic.model || 'claude-3-5-sonnet-20241022');
                  }
                  if (result.config.ai_config.local) {
                    setLocalUrl(result.config.ai_config.local.base_url || 'http://localhost:11434');
                    setLocalModel(result.config.ai_config.local.model || 'llama2');
                  }
                }
              }
            } catch (err) {
              console.error('Failed to load config:', err);
            }
          };

          const saveSettings = async () => {
            setSavingSettings(true);
            try {
              const response = await fetch(`${API_BASE}/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  collection_interval_minutes: tempBackendInterval,
                  ui_refresh_interval_minutes: tempUiInterval,
                  proxmox_auth_method: 'api_token',
                  proxmox_api_token_id: proxmoxTokenId,
                  proxmox_api_token_secret: proxmoxTokenSecret,
                  ai_provider: aiProvider,
                  ai_recommendations_enabled: aiEnabled,
                  ai_config: {
                    openai: {
                      api_key: openaiKey,
                      model: openaiModelCustom || openaiModel
                    },
                    anthropic: {
                      api_key: anthropicKey,
                      model: anthropicModel
                    },
                    local: {
                      base_url: localUrl,
                      model: localModelCustom || localModel
                    }
                  }
                })
              });
              
              const result = await response.json();
              if (result.success) {
                setConfig(result.config);
                const intervalMs = tempUiInterval * 60 * 1000;
                setAutoRefreshInterval(intervalMs);
                setShowSettings(false);
                
                const now = new Date();
                setLastUpdate(now);
                setNextUpdate(new Date(now.getTime() + intervalMs));
              } else {
                alert('Failed to save settings: ' + result.error);
              }
            } catch (err) {
              alert('Failed to save settings: ' + err.message);
            }
            setSavingSettings(false);
          };

          const toggleDarkMode = () => {
            setDarkMode(!darkMode);
            document.documentElement.classList.toggle('dark');
          };

          const formatLocalTime = (date) => {
            return new Date(date).toLocaleString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: true
            });
          };

          const getTimezoneAbbr = () => {
            const date = new Date();
            const timeZoneName = date.toLocaleTimeString('en-US', { timeZoneName: 'short' }).split(' ').pop();
            return timeZoneName;
          };

          const handleRefresh = async () => {
            setLoading(true);
            setError(null);
            try {
              const refreshResponse = await fetch(`${API_BASE}/refresh`, { method: 'POST' });
              if (!refreshResponse.ok) throw new Error('Failed to trigger data collection');
              await new Promise(resolve => setTimeout(resolve, 45000));
              await fetchAnalysis();
            } catch (err) {
              setError(`Refresh failed: ${err.message}`);
              setLoading(false);
            }
          };

          const fetchAnalysis = async () => {
            setLoading(true);
            setError(null);
            try {
              const response = await fetch(`${API_BASE}/analyze`);
              
              if (!response.ok) {
                if (response.status === 503) {
                  const result = await response.json();
                  setError(result.error || 'Service temporarily unavailable');
                } else {
                  setError(`Server error: ${response.status}`);
                }
                setLoading(false);
                return;
              }
              
              const result = await response.json();
              if (result.success && result.data) {
                setData(result.data);
                const now = new Date();
                setLastUpdate(now);
                setNextUpdate(new Date(now.getTime() + autoRefreshInterval));
                if (result.data.collected_at) {
                  setBackendCollected(new Date(result.data.collected_at));
                }
              } else {
                setError(result.error || 'No data received');
              }
            } catch (err) {
              setError(`Connection failed: ${err.message}`);
            }
            setLoading(false);
          };

          const fetchRecommendations = async () => {
            if (!data) return;
            try {
              const response = await fetch(`${API_BASE}/recommendations`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cpu_threshold: cpuThreshold, mem_threshold: memThreshold })
              });
              const result = await response.json();
              if (result.success) {
                setRecommendations(result.recommendations);
              }
            } catch (err) {
              console.error(err);
            }
          };

          const fetchAiRecommendations = async () => {
            if (!data) return;
            setLoadingAi(true);
            try {
              const response = await fetch(`${API_BASE}/ai-recommendations`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  cpu_threshold: cpuThreshold,
                  mem_threshold: memThreshold,
                  analysis_period: aiAnalysisPeriod
                })
              });
              const result = await response.json();
              if (result.success) {
                setAiRecommendations(result);
              } else {
                setAiRecommendations({ success: false, error: result.error });
              }
            } catch (err) {
              setAiRecommendations({ success: false, error: err.message });
            }
            setLoadingAi(false);
          };

          const fetchAiModels = async (provider, apiKey = null, baseUrl = null) => {
            const setLoading = provider === 'openai' ? setOpenaiLoadingModels
              : provider === 'anthropic' ? setAnthropicLoadingModels
              : setLocalLoadingModels;
            const setModels = provider === 'openai' ? setOpenaiAvailableModels
              : provider === 'anthropic' ? setAnthropicAvailableModels
              : setLocalAvailableModels;

            setLoading(true);
            try {
              const payload = { provider };
              if (apiKey) payload.api_key = apiKey;
              if (baseUrl) payload.base_url = baseUrl;

              const response = await fetch(`${API_BASE}/ai-models`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              const result = await response.json();
              if (result.success) {
                setModels(result.models);
              } else {
                alert(`Failed to fetch models: ${result.error}`);
              }
            } catch (err) {
              alert(`Failed to fetch models: ${err.message}`);
            }
            setLoading(false);
          };

          const fetchSystemInfo = async () => {
            try {
              const response = await fetch(`${API_BASE}/system/info`);
              const result = await response.json();
              if (result.success) {
                setSystemInfo(result);
              }
            } catch (err) {
              console.error('Failed to fetch system info:', err);
            }
          };

          const handleUpdate = async () => {
            setUpdating(true);
            setUpdateLog([]);
            setShowUpdateModal(true);

            try {
              const response = await fetch(`${API_BASE}/system/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });
              const result = await response.json();

              if (result.success) {
                setUpdateLog(result.log || []);
                if (result.updated) {
                  // Refresh system info after update
                  setTimeout(() => {
                    fetchSystemInfo();
                    // Reload page to get new code
                    setTimeout(() => window.location.reload(), 2000);
                  }, 1000);
                }
              } else {
                setUpdateLog([...(result.log || []), `Error: ${result.error}`]);
              }
            } catch (err) {
              setUpdateLog(prev => [...prev, `Error: ${err.message}`]);
            }

            setUpdating(false);
          };

          const fetchBranches = async () => {
            setLoadingBranches(true);
            try {
              const response = await fetch(`${API_BASE}/system/branches`);
              const result = await response.json();
              if (result.success) {
                setAvailableBranches(result.branches || []);
              } else {
                console.error('Failed to fetch branches:', result.error);
              }
            } catch (err) {
              console.error('Error fetching branches:', err);
            }
            setLoadingBranches(false);
          };

          const switchBranch = async (branchName) => {
            setSwitchingBranch(true);
            try {
              const response = await fetch(`${API_BASE}/system/switch-branch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ branch: branchName })
              });
              const result = await response.json();

              if (result.success) {
                setShowBranchModal(false);
                await fetchSystemInfo();
                alert(`Successfully switched to branch: ${branchName}\n\nThe page will reload to apply changes.`);
                setTimeout(() => window.location.reload(), 1000);
              } else {
                alert(`Failed to switch branch: ${result.error}`);
              }
            } catch (err) {
              alert(`Error switching branch: ${err.message}`);
            }
            setSwitchingBranch(false);
          };

          const executeMigration = async (rec) => {
            const key = `${rec.vmid}-${rec.target_node}`;
            setMigrationStatus(prev => ({ ...prev, [key]: 'running' }));
            
            try {
              const response = await fetch(`${API_BASE}/migrate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  source_node: rec.source_node,
                  vmid: rec.vmid,
                  target_node: rec.target_node,
                  type: rec.type
                })
              });
              
              const result = await response.json();
              setMigrationStatus(prev => ({
                ...prev,
                [key]: result.success ? 'success' : 'failed'
              }));

              if (result.success) {
                alert(`Migration started for ${rec.type} ${rec.vmid} (${rec.name || 'unnamed'}).\n\nCheck Proxmox cluster task logs for migration status and progress.`);
                setTimeout(() => fetchAnalysis(), 5000);
              }
            } catch (err) {
              setMigrationStatus(prev => ({ ...prev, [key]: 'failed' }));
            }
          };

          const executeBatchMigration = async () => {
            if (!window.confirm(`Start ${recommendations.length} migration(s)?\n\nYou can monitor progress in Proxmox task logs.`)) return;
            
            setLoading(true);
            try {
              const response = await fetch(`${API_BASE}/migrate/batch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ migrations: recommendations })
              });
              
              const result = await response.json();
              if (result.success) {
                result.results.forEach(r => {
                  const key = `${r.vmid}-batch`;
                  setMigrationStatus(prev => ({ 
                    ...prev, 
                    [key]: r.success ? 'success' : 'failed' 
                  }));
                });
                setTimeout(() => fetchAnalysis(), 5000);
              }
            } catch (err) {
              setError(`Batch migration failed: ${err.message}`);
            }
            setLoading(false);
          };

          const checkAffinityViolations = () => {
            if (!data) return [];
            const violations = [];
            
            Object.values(data.nodes).forEach(node => {
              const guestsOnNode = node.guests.map(gid => data.guests[gid]);
              
              guestsOnNode.forEach(guest => {
                if (guest.tags.exclude_groups.length > 0) {
                  guest.tags.exclude_groups.forEach(excludeTag => {
                    const conflicts = guestsOnNode.filter(other => 
                      other.vmid !== guest.vmid && 
                      other.tags.all_tags.includes(excludeTag)
                    );
                    
                    if (conflicts.length > 0) {
                      violations.push({
                        guest: guest,
                        node: node.name,
                        excludeTag: excludeTag,
                        conflicts: conflicts
                      });
                    }
                  });
                }
              });
            });
            
            return violations;
          };

          useEffect(() => { fetchAnalysis(); }, []);
          useEffect(() => {
            const interval = setInterval(() => {
              fetchAnalysis();
            }, autoRefreshInterval);
            return () => clearInterval(interval);
          }, [autoRefreshInterval]);
          useEffect(() => { if (data) fetchRecommendations(); }, [data, cpuThreshold, memThreshold]);

          // Render charts when data changes or chart period changes
          useEffect(() => {
            if (!data || !data.nodes) return;
            // Skip chart initialization when node status section is collapsed
            if (collapsedSections.nodeStatus) return;
            if (typeof Chart === 'undefined') {
              console.error('Chart.js is not loaded');
              return;
            }

            // Destroy old charts
            Object.values(charts).forEach(chart => {
              try {
                chart.destroy();
              } catch (e) {
                console.error('Error destroying chart:', e);
              }
            });
            const newCharts = {};

            Object.values(data.nodes).forEach(node => {
              if (!node.trend_data || node.trend_data.length === 0) {
                return;
              }

              const canvas = document.getElementById(`chart-${node.name}`);
              if (!canvas) {
                console.error(`Canvas not found for node ${node.name}`);
                return;
              }

              // Filter data based on chart period
              const now = Math.floor(Date.now() / 1000);
              const periodSeconds = {
                '1h': 3600,
                '6h': 6 * 3600,
                '12h': 12 * 3600,
                '24h': 24 * 3600
              }[chartPeriod] || 24 * 3600;

              const filteredData = node.trend_data.filter(point =>
                (now - point.time) <= periodSeconds
              );

              if (filteredData.length === 0) {
                return;
              }

              // Reduce data points for longer periods to improve performance and readability
              // Sample rate increases with period: 1h=1 (all), 6h=10, 12h=20, 24h=40
              const sampleRate = {
                '1h': 1,
                '6h': 10,
                '12h': 20,
                '24h': 40
              }[chartPeriod] || 1;

              // Always keep first and last points for accurate range display
              const sampledData = filteredData.filter((point, index, arr) =>
                index === 0 || index === arr.length - 1 || index % sampleRate === 0
              );

              const ctx = canvas.getContext('2d');
              const isDark = darkMode;

              try {
                newCharts[node.name] = new Chart(ctx, {
                type: 'line',
                data: {
                  labels: sampledData.map(point => {
                    const date = new Date(point.time * 1000);
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                  }),
                  datasets: [
                    {
                      label: 'CPU %',
                      data: sampledData.map(point => point.cpu),
                      borderColor: 'rgb(59, 130, 246)',
                      backgroundColor: 'rgba(59, 130, 246, 0.1)',
                      tension: 0.4,
                      fill: true
                    },
                    {
                      label: 'Memory %',
                      data: sampledData.map(point => point.mem),
                      borderColor: 'rgb(16, 185, 129)',
                      backgroundColor: 'rgba(16, 185, 129, 0.1)',
                      tension: 0.4,
                      fill: true
                    }
                  ]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  interaction: {
                    mode: 'index',
                    intersect: false,
                  },
                  plugins: {
                    legend: {
                      display: true,
                      position: 'top',
                      labels: {
                        color: isDark ? '#9ca3af' : '#4b5563',
                        font: { size: 11 }
                      }
                    },
                    tooltip: {
                      backgroundColor: isDark ? '#1f2937' : '#ffffff',
                      titleColor: isDark ? '#f3f4f6' : '#111827',
                      bodyColor: isDark ? '#d1d5db' : '#374151',
                      borderColor: isDark ? '#374151' : '#e5e7eb',
                      borderWidth: 1
                    },
                    annotation: {
                      annotations: {
                        cpuThresholdLine: {
                          type: 'line',
                          yMin: cpuThreshold,
                          yMax: cpuThreshold,
                          borderColor: 'rgba(239, 68, 68, 0.3)',
                          borderWidth: 2,
                          borderDash: [5, 5],
                          label: {
                            display: true,
                            content: `CPU Threshold: ${cpuThreshold}%`,
                            position: 'end',
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            color: '#ffffff',
                            font: { size: 10 },
                            padding: 4
                          }
                        },
                        memThresholdLine: {
                          type: 'line',
                          yMin: memThreshold,
                          yMax: memThreshold,
                          borderColor: 'rgba(249, 115, 22, 0.3)',
                          borderWidth: 2,
                          borderDash: [5, 5],
                          label: {
                            display: true,
                            content: `Mem Threshold: ${memThreshold}%`,
                            position: 'start',
                            backgroundColor: 'rgba(249, 115, 22, 0.6)',
                            color: '#ffffff',
                            font: { size: 10 },
                            padding: 4
                          }
                        }
                      }
                    }
                  },
                  scales: {
                    x: {
                      display: true,
                      grid: {
                        color: isDark ? '#374151' : '#e5e7eb'
                      },
                      ticks: {
                        color: isDark ? '#9ca3af' : '#6b7280',
                        maxTicksLimit: 8,
                        font: { size: 10 }
                      }
                    },
                    y: {
                      display: true,
                      min: 0,
                      max: 100,
                      grid: {
                        color: isDark ? '#374151' : '#e5e7eb'
                      },
                      ticks: {
                        color: isDark ? '#9ca3af' : '#6b7280',
                        font: { size: 10 },
                        callback: function(value) {
                          return value + '%';
                        }
                      }
                    }
                  }
                }
              });
              } catch (error) {
                console.error(`Error creating chart for node ${node.name}:`, error);
              }
            });

            setCharts(newCharts);

            // Cleanup on unmount
            return () => {
              Object.values(newCharts).forEach(chart => chart.destroy());
            };
          }, [data, chartPeriod, darkMode, collapsedSections.nodeStatus, cpuThreshold, memThreshold]);

          if (error) {
            return (
              <div className="min-h-screen bg-gray-100 dark:bg-gray-900 p-8">
                <div className="max-w-7xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow-lg p-8">
                  <div className="flex items-center gap-3 text-red-600 dark:text-red-400">
                    <AlertCircle size={24} />
                    <div>
                      <h3 className="text-lg font-semibold">Error</h3>
                      <p className="text-sm">{error}</p>
                    </div>
                  </div>
                  <button onClick={handleRefresh} className="mt-4 px-4 py-2 bg-blue-600 dark:bg-blue-500 text-white rounded hover:bg-blue-700 dark:hover:bg-blue-600">Retry</button>
                </div>
              </div>
            );
          }

          if (!data) {
            return (
              <div className="min-h-screen bg-gray-100 dark:bg-gray-900 flex items-center justify-center">
                <div className="text-center">
                  <RefreshCw size={48} className="animate-spin mx-auto mb-4 text-blue-600 dark:text-blue-400" />
                  <p className="text-gray-600 dark:text-gray-300">Loading cluster data...</p>
                </div>
              </div>
            );
          }

          const ignoredGuests = Object.values(data.guests).filter(g => g.tags.has_ignore);
          const excludeGuests = Object.values(data.guests).filter(g => g.tags.exclude_groups.length > 0);
          const violations = checkAffinityViolations();

          return (<>
            <div className="min-h-screen bg-gray-100 dark:bg-gray-900 p-4">
              <div className="max-w-7xl mx-auto">
                <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                  <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center gap-2">
                      <ProxBalanceLogo size={96} />
                      <div>
                        <h1 className="text-3xl font-bold text-gray-900 dark:text-white">ProxBalance</h1>
                        <p className="text-sm text-gray-500 dark:text-gray-400">Cluster Optimization</p>
                        {systemInfo && (
                          <div className="flex items-center gap-2 mt-1">
                            <span className="text-xs text-gray-500 dark:text-gray-500">
                              Branch: <button
                                onClick={() => { fetchBranches(); setShowBranchModal(true); }}
                                className="font-mono text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 underline decoration-dotted cursor-pointer"
                                title="Click to switch branch"
                              >{systemInfo.branch}</button>
                            </span>
                            <span className="text-xs text-gray-400 dark:text-gray-600">|</span>
                            <span className="text-xs text-gray-500 dark:text-gray-500">
                              Commit: <span className="font-mono">{systemInfo.commit}</span>
                            </span>
                            {systemInfo.updates_available && (
                              <>
                                <span className="text-xs text-gray-400 dark:text-gray-600">|</span>
                                <span className="text-xs text-yellow-600 dark:text-yellow-400 font-semibold">
                                  {systemInfo.commits_behind} update{systemInfo.commits_behind > 1 ? 's' : ''} available
                                </span>
                              </>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      {systemInfo && systemInfo.updates_available && (
                        <button
                          onClick={() => setShowUpdateModal(true)}
                          className="flex items-center gap-2 px-4 py-2 bg-yellow-600 dark:bg-yellow-500 text-white rounded hover:bg-yellow-700 dark:hover:bg-yellow-600"
                          title={`${systemInfo.commits_behind} update(s) available`}
                        >
                          <RefreshCw size={18} />
                          Update Available
                        </button>
                      )}
                      <a
                        href="https://github.com/Pr0zak/ProxBalance"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600"
                        title="View on GitHub"
                      >
                        <GitHub size={20} className="text-gray-700 dark:text-gray-300" />
                      </a>
                      <button
                        onClick={toggleDarkMode}
                        className="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600"
                        title={darkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                      >
                        {darkMode ? <Sun size={20} className="text-yellow-500" /> : <Moon size={20} className="text-gray-700" />}
                      </button>
                      <button
                        onClick={() => setShowSettings(true)}
                        className="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600"
                        title="Settings"
                      >
                        <Settings size={20} className="text-gray-700 dark:text-gray-300" />
                      </button>
                    </div>
                  </div>

                  {lastUpdate && (
                    <div className="flex items-center gap-3 mb-4 text-xs text-gray-500 dark:text-gray-500">
                      <div className="flex items-center gap-1">
                        <Clock size={12} />
                        <span>UI refreshed: <span className="font-semibold text-gray-700 dark:text-gray-300">{formatLocalTime(lastUpdate)} {getTimezoneAbbr()}</span></span>
                      </div>
                      {backendCollected && (
                        <div className="flex items-center gap-2">
                          <Server size={12} />
                          <span>Data collected: <span className="font-semibold text-green-600 dark:text-green-400">{formatLocalTime(backendCollected)} {getTimezoneAbbr()}</span></span>
                          <button
                            onClick={handleRefresh}
                            disabled={loading}
                            className="flex items-center gap-1 px-2 py-1 text-xs bg-blue-600 dark:bg-blue-500 text-white rounded hover:bg-blue-700 dark:hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed"
                            title="Refresh cluster data from Proxmox"
                          >
                            <RefreshCw size={12} className={loading ? 'animate-spin' : ''} />
                            Refresh Data
                          </button>
                        </div>
                      )}
                      {config && (
                        <span className="text-gray-400 dark:text-gray-600 text-xs">
                          (Backend: {config.collection_interval_minutes}m, UI: {config.ui_refresh_interval_minutes}m)
                        </span>
                      )}
                    </div>
                  )}
                  
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div className="bg-blue-50 dark:bg-blue-900/30 p-4 rounded">
                      <div className="flex items-center gap-2 mb-2">
                        <Server size={20} className="text-blue-600 dark:text-blue-400" />
                        <span className="text-xs text-gray-500 dark:text-gray-500">Nodes</span>
                      </div>
                      <p className="text-2xl font-bold text-blue-600 dark:text-blue-400">{data.summary.total_nodes}</p>
                    </div>
                    <div className="bg-green-50 dark:bg-green-900/30 p-4 rounded">
                      <div className="flex items-center gap-2 mb-2">
                        <HardDrive size={20} className="text-green-600 dark:text-green-400" />
                        <span className="text-xs text-gray-500 dark:text-gray-500">Guests</span>
                      </div>
                      <p className="text-2xl font-bold text-green-600 dark:text-green-400">{data.summary.total_guests}</p>
                      <p className="text-xs text-gray-500 dark:text-gray-500">{data.summary.vms} VMs, {data.summary.containers} CTs</p>
                    </div>
                    <div className="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded">
                      <div className="flex items-center gap-2 mb-2">
                        <Activity size={20} className="text-yellow-600 dark:text-yellow-400" />
                        <span className="text-xs text-gray-500 dark:text-gray-500">Recommendations</span>
                      </div>
                      <p className="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{recommendations.length}</p>
                    </div>
                    <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded">
                      <div className="flex items-center gap-2 mb-2">
                        <AlertCircle size={20} className="text-purple-600 dark:text-purple-400" />
                        <span className="text-xs text-gray-500 dark:text-gray-500">Tagged</span>
                      </div>
                      <p className="text-2xl font-bold text-purple-600 dark:text-purple-400">{data.summary.ignored_guests + data.summary.excluded_guests}</p>
                    </div>
                  </div>
                </div>

                {(ignoredGuests.length > 0 || excludeGuests.length > 0 || violations.length > 0) && (
                  <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-2">
                        <Tag size={24} className="text-purple-600 dark:text-purple-400" />
                        <h2 className="text-xl font-bold text-gray-900 dark:text-white">Tagged Guests & Affinity Rules</h2>
                        <button
                          onClick={() => toggleSection('taggedGuests')}
                          className="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                          title={collapsedSections.taggedGuests ? "Expand section" : "Collapse section"}
                        >
                          {collapsedSections.taggedGuests ? (
                            <ChevronDown size={20} className="text-gray-600 dark:text-gray-400" />
                          ) : (
                            <ChevronUp size={20} className="text-gray-600 dark:text-gray-400" />
                          )}
                        </button>
                      </div>
                    </div>

                    {collapsedSections.taggedGuests ? (
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {violations.length > 0 && (
                          <div className="flex items-center gap-3 p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded">
                            <AlertTriangle size={18} className="text-red-600 dark:text-red-400" />
                            <div>
                              <div className="font-semibold text-red-900 dark:text-red-300">Violations</div>
                              <div className="text-sm text-red-700 dark:text-red-400">{violations.length} issue{violations.length !== 1 ? 's' : ''}</div>
                            </div>
                          </div>
                        )}
                        {ignoredGuests.length > 0 && (
                          <div className="flex items-center gap-3 p-3 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 rounded">
                            <Shield size={18} className="text-yellow-600 dark:text-yellow-400" />
                            <div>
                              <div className="font-semibold text-gray-900 dark:text-white">Ignored Guests</div>
                              <div className="text-sm text-gray-600 dark:text-gray-400">{ignoredGuests.length} guest{ignoredGuests.length !== 1 ? 's' : ''}</div>
                            </div>
                          </div>
                        )}
                        {excludeGuests.length > 0 && (
                          <div className="flex items-center gap-3 p-3 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded">
                            <Shield size={18} className="text-blue-600 dark:text-blue-400" />
                            <div>
                              <div className="font-semibold text-gray-900 dark:text-white">Affinity Rules</div>
                              <div className="text-sm text-gray-600 dark:text-gray-400">{excludeGuests.length} guest{excludeGuests.length !== 1 ? 's' : ''}</div>
                            </div>
                          </div>
                        )}
                      </div>
                    ) : (
                    <>
                    {violations.length > 0 && (
                      <div className="mb-6 p-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded">
                        <div className="flex items-center gap-2 mb-3">
                          <AlertTriangle size={20} className="text-red-600 dark:text-red-400" />
                          <h3 className="font-semibold text-red-900 dark:text-red-300">Affinity Rule Violations</h3>
                        </div>
                        <div className="space-y-3">
                          {violations.map((v, idx) => (
                            <div key={idx} className="bg-white dark:bg-gray-900 p-3 rounded border border-red-300 dark:border-red-700">
                              <p className="font-semibold text-red-900 dark:text-red-300">
                                [{v.guest.type} {v.guest.vmid}] {v.guest.name} on {v.node}
                              </p>
                              <p className="text-sm text-red-700 dark:text-red-400 mt-1">
                                Has exclusion tag <span className="font-mono bg-red-100 dark:bg-red-900/50 px-1 rounded">{v.excludeTag}</span> but shares node with:
                              </p>
                              <ul className="mt-2 ml-4 text-sm text-red-700 dark:text-red-400">
                                {v.conflicts.map(c => (
                                  <li key={c.vmid}>• [{c.type} {c.vmid}] {c.name}</li>
                                ))}
                              </ul>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      {ignoredGuests.length > 0 && (
                        <div>
                          <div className="flex items-center gap-2 mb-3">
                            <Shield size={18} className="text-yellow-600 dark:text-yellow-400" />
                            <h3 className="font-semibold text-gray-900 dark:text-white">Ignored Guests ({ignoredGuests.length})</h3>
                          </div>
                          <p className="text-xs text-gray-600 dark:text-gray-400 mb-3">These guests will never be migrated</p>
                          <div className="space-y-2">
                            {ignoredGuests.map(guest => (
                              <div key={guest.vmid} className="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 p-3 rounded">
                                <div className="flex items-center justify-between">
                                  <div>
                                    <p className="font-semibold text-sm text-gray-900 dark:text-gray-100">[{guest.type} {guest.vmid}] {guest.name}</p>
                                    <p className="text-xs text-gray-600 dark:text-gray-400">Node: {guest.node}</p>
                                  </div>
                                  <span className="text-xs px-2 py-1 bg-yellow-200 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200 rounded font-medium">ignore</span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {excludeGuests.length > 0 && (
                        <div>
                          <div className="flex items-center gap-2 mb-3">
                            <Shield size={18} className="text-blue-600 dark:text-blue-400" />
                            <h3 className="font-semibold text-gray-900 dark:text-white">Affinity Rules ({excludeGuests.length})</h3>
                          </div>
                          <p className="text-xs text-gray-600 dark:text-gray-400 mb-3">These guests have anti-affinity requirements</p>
                          <div className="space-y-2">
                            {excludeGuests.map(guest => (
                              <div key={guest.vmid} className="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 p-3 rounded">
                                <div className="flex items-center justify-between mb-2">
                                  <div>
                                    <p className="font-semibold text-sm text-gray-900 dark:text-gray-100">[{guest.type} {guest.vmid}] {guest.name}</p>
                                    <p className="text-xs text-gray-600 dark:text-gray-400">Node: {guest.node}</p>
                                  </div>
                                </div>
                                <div className="flex flex-wrap gap-1">
                                  {guest.tags.exclude_groups.map(tag => (
                                    <span key={tag} className="text-xs px-2 py-1 bg-blue-200 dark:bg-blue-800 text-blue-800 dark:text-blue-200 rounded font-medium">{tag}</span>
                                  ))}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                    </>
                    )}
                  </div>
                )}

                {data && (
                  <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-2">
                        <Server size={24} className="text-blue-600 dark:text-blue-400" />
                        <h2 className="text-xl font-bold text-gray-900 dark:text-white">Cluster Map</h2>
                        <button
                          onClick={() => toggleSection('clusterMap')}
                          className="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                          title={collapsedSections.clusterMap ? "Expand section" : "Collapse section"}
                        >
                          {collapsedSections.clusterMap ? (
                            <ChevronDown size={20} className="text-gray-600 dark:text-gray-400" />
                          ) : (
                            <ChevronUp size={20} className="text-gray-600 dark:text-gray-400" />
                          )}
                        </button>
                      </div>
                    </div>

                    {!collapsedSections.clusterMap && (
                      <div className="relative" style={{minHeight: '400px'}}>
                        <div className="flex flex-wrap gap-8 justify-center items-start py-8">
                          {Object.values(data.nodes).map(node => {
                            const nodeGuests = Object.values(data.guests || {}).filter(g => g.node === node.name && g.status === 'running');
                            const maxResources = Math.max(...Object.values(data.guests || {}).map(g => {
                              const cpuUsage = g.cpu_current || 0;
                              const memPercent = g.mem_max_gb > 0 ? ((g.mem_used_gb || 0) / g.mem_max_gb) * 100 : 0;
                              return cpuUsage + memPercent;
                            }), 1);

                            return (
                              <div key={node.name} className="flex flex-col items-center gap-4">
                                {/* Host Node */}
                                <div className="relative group">
                                  <div className={`w-32 h-40 rounded-lg border-4 flex flex-col items-center justify-between p-2 overflow-hidden ${
                                    node.status === 'online'
                                      ? 'bg-gray-50 dark:bg-gray-900 border-blue-500 dark:border-blue-600'
                                      : 'bg-gray-100 dark:bg-gray-800 border-gray-400 dark:border-gray-600'
                                  }`}>
                                    {/* Node header */}
                                    <div className="flex flex-col items-center z-10">
                                      <Server size={28} className={node.status === 'online' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-500'} />
                                      <div className="text-sm font-bold text-gray-900 dark:text-white mt-1">{node.name}</div>
                                      <div className="text-xs text-gray-600 dark:text-gray-400">{nodeGuests.length} guests</div>
                                    </div>

                                    {/* Capacity indicators */}
                                    <div className="w-full space-y-2 z-10">
                                      {/* CPU Bar */}
                                      <div className="relative">
                                        <div className="text-xs mb-1">
                                          <span className="text-gray-600 dark:text-gray-400 font-medium">CPU</span>
                                        </div>
                                        <div className="w-full h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                          <div
                                            className={`h-full rounded-full transition-all duration-500 ${
                                              (node.cpu_percent || 0) > 80 ? 'bg-red-500' :
                                              (node.cpu_percent || 0) > 60 ? 'bg-yellow-500' :
                                              'bg-green-500'
                                            }`}
                                            style={{width: `${Math.min(100, node.cpu_percent || 0)}%`}}
                                          ></div>
                                        </div>
                                      </div>

                                      {/* Memory Bar */}
                                      <div className="relative">
                                        <div className="text-xs mb-1">
                                          <span className="text-gray-600 dark:text-gray-400 font-medium">MEM</span>
                                        </div>
                                        <div className="w-full h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                          <div
                                            className={`h-full rounded-full transition-all duration-500 ${
                                              (node.mem_percent || 0) > 80 ? 'bg-red-500' :
                                              (node.mem_percent || 0) > 70 ? 'bg-yellow-500' :
                                              'bg-blue-500'
                                            }`}
                                            style={{width: `${Math.min(100, node.mem_percent || 0)}%`}}
                                          ></div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  {/* Host tooltip */}
                                  <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 dark:bg-gray-700 text-white text-xs rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
                                    <div><strong>{node.name}</strong></div>
                                    <div>CPU: {(node.cpu_percent || 0).toFixed(1)}%</div>
                                    <div>Memory: {(node.mem_percent || 0).toFixed(1)}%</div>
                                    <div>Cores: {node.cpu_cores || 0}</div>
                                  </div>
                                </div>

                                {/* Connection line */}
                                {nodeGuests.length > 0 && (
                                  <div className="w-0.5 h-8 bg-gradient-to-b from-blue-400 to-transparent dark:from-blue-600"></div>
                                )}

                                {/* Guests */}
                                <div className="flex flex-wrap gap-3 justify-center max-w-xs">
                                  {nodeGuests.map(guest => {
                                    const cpuUsage = guest.cpu_current || 0;
                                    const memPercent = guest.mem_max_gb > 0 ? ((guest.mem_used_gb || 0) / guest.mem_max_gb) * 100 : 0;
                                    const resourceUsage = cpuUsage + memPercent;
                                    const sizeRatio = maxResources > 0 ? (resourceUsage / maxResources) : 0.3;
                                    const size = Math.max(30, Math.min(80, 30 + (sizeRatio * 50)));

                                    const getGuestColor = () => {
                                      const guestType = (guest.type || '').toUpperCase();
                                      if (guestType === 'CT' || guestType === 'LXC') return 'bg-green-500 dark:bg-green-600';
                                      if (guestType === 'VM' || guestType === 'QEMU') return 'bg-purple-500 dark:bg-purple-600';
                                      return 'bg-gray-500 dark:bg-gray-600';
                                    };

                                    return (
                                      <div key={guest.vmid} className="relative group">
                                        <div
                                          className={`rounded-full ${getGuestColor()} flex items-center justify-center text-white font-bold shadow-lg hover:shadow-xl transition-all cursor-pointer`}
                                          style={{width: `${size}px`, height: `${size}px`, fontSize: `${Math.max(10, size/4)}px`}}
                                        >
                                          {guest.vmid}
                                        </div>

                                        {/* Guest tooltip */}
                                        <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 dark:bg-gray-700 text-white text-xs rounded shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-10">
                                          <div><strong>{guest.name || `Guest ${guest.vmid}`}</strong></div>
                                          <div>Type: {((guest.type || '').toUpperCase() === 'VM' || (guest.type || '').toUpperCase() === 'QEMU') ? 'VM' : 'Container'}</div>
                                          <div>CPU: {cpuUsage.toFixed(1)}%</div>
                                          <div>Memory: {memPercent.toFixed(1)}% ({(guest.mem_used_gb || 0).toFixed(1)} / {(guest.mem_max_gb || 0).toFixed(1)} GB)</div>
                                          <div>Status: {guest.status}</div>
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                              </div>
                            );
                          })}
                        </div>

                        {/* Legend */}
                        <div className="flex items-center justify-center gap-6 mt-6 text-xs text-gray-600 dark:text-gray-400">
                          <div className="flex items-center gap-2">
                            <div className="w-6 h-6 rounded-full bg-purple-500 dark:bg-purple-600"></div>
                            <span>VM</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <div className="w-6 h-6 rounded-full bg-green-500 dark:bg-green-600"></div>
                            <span>Container</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <span>Circle size = CPU + Memory usage</span>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                  <div className="flex items-center justify-between mb-4">
                    <div className="flex items-center gap-2">
                      <HardDrive size={24} className="text-cyan-600 dark:text-cyan-400" />
                      <h2 className="text-xl font-bold text-gray-900 dark:text-white">Node Status</h2>
                      <button
                        onClick={() => toggleSection('nodeStatus')}
                        className="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                        title={collapsedSections.nodeStatus ? "Expand section" : "Collapse section"}
                      >
                        {collapsedSections.nodeStatus ? (
                          <ChevronDown size={20} className="text-gray-600 dark:text-gray-400" />
                        ) : (
                          <ChevronUp size={20} className="text-gray-600 dark:text-gray-400" />
                        )}
                      </button>
                    </div>
                    <div className="flex items-center gap-4">
                      <div className="flex items-center gap-2">
                        <label className="text-sm text-gray-600 dark:text-gray-400">Grid:</label>
                        <div className="flex gap-1">
                          {[1, 2, 3, 4].map(cols => (
                            <button
                              key={cols}
                              onClick={() => setNodeGridColumns(cols)}
                              className={`px-3 py-1 text-sm rounded transition-colors ${
                                nodeGridColumns === cols
                                  ? 'bg-blue-600 text-white'
                                  : 'bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600'
                              }`}
                              title={`${cols} column${cols > 1 ? 's' : ''}`}
                            >
                              {cols}
                            </button>
                          ))}
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <label className="text-sm text-gray-600 dark:text-gray-400">Chart Period:</label>
                        <select
                          value={chartPeriod}
                          onChange={(e) => setChartPeriod(e.target.value)}
                          className="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                        >
                          <option value="1h">1 Hour</option>
                          <option value="6h">6 Hours</option>
                          <option value="12h">12 Hours</option>
                          <option value="24h">24 Hours</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  {collapsedSections.nodeStatus ? (
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-3">
                      {Object.values(data.nodes).map(node => (
                        <div key={node.name} className="border border-gray-200 dark:border-gray-700 rounded p-3 hover:shadow-md transition-shadow">
                          <div className="flex items-center justify-between mb-2">
                            <h3 className="text-sm font-semibold text-gray-900 dark:text-white">{node.name}</h3>
                            <span className={`w-2 h-2 rounded-full ${node.status === 'online' ? 'bg-green-500' : 'bg-red-500'}`} title={node.status}></span>
                          </div>
                          <div className="space-y-1 text-xs">
                            <div className="flex justify-between">
                              <span className="text-gray-600 dark:text-gray-400">CPU:</span>
                              <span className={`font-semibold ${(node.cpu_percent || 0) > cpuThreshold ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`}>
                                {(node.cpu_percent || 0).toFixed(1)}%
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600 dark:text-gray-400">Memory:</span>
                              <span className={`font-semibold ${(node.mem_percent || 0) > memThreshold ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`}>
                                {(node.mem_percent || 0).toFixed(1)}%
                              </span>
                            </div>
                            <div className="flex justify-between pt-1 border-t border-gray-200 dark:border-gray-600">
                              <span className="text-gray-600 dark:text-gray-400">Guests:</span>
                              <span className="font-semibold text-gray-900 dark:text-white">{node.guests?.length || 0}</span>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                  <div className={`grid gap-4 transition-all duration-300 ease-in-out ${
                    nodeGridColumns === 1 ? 'grid-cols-1' :
                    nodeGridColumns === 2 ? 'grid-cols-1 lg:grid-cols-2' :
                    nodeGridColumns === 3 ? 'grid-cols-1 md:grid-cols-2 xl:grid-cols-3' :
                    'grid-cols-1 md:grid-cols-2 xl:grid-cols-4'
                  }`}>
                    {Object.values(data.nodes).map(node => (
                      <div key={node.name} className="border border-gray-200 dark:border-gray-700 rounded p-4">
                        <div className="flex items-center justify-between mb-2">
                          <h3 className="text-lg font-semibold text-gray-900 dark:text-white">{node.name}</h3>
                          <span className={`text-sm font-medium ${node.status === 'online' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>{node.status}</span>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm mb-4">
                          <div><span className="text-gray-600 dark:text-gray-400">CPU:</span> <span className={`font-semibold ${(node.cpu_percent || 0) > cpuThreshold ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`}>{(node.cpu_percent || 0).toFixed(1)}%</span></div>
                          <div><span className="text-gray-600 dark:text-gray-400">Memory:</span> <span className={`font-semibold ${(node.mem_percent || 0) > memThreshold ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}`}>{(node.mem_percent || 0).toFixed(1)}%</span></div>
                          <div><span className="text-gray-600 dark:text-gray-400">Cores:</span> <span className="font-semibold text-gray-900 dark:text-white">{node.cpu_cores || 0}</span></div>
                          <div><span className="text-gray-600 dark:text-gray-400">Guests:</span> <span className="font-semibold text-gray-900 dark:text-white">{node.guests?.length || 0}</span></div>
                        </div>
                        {node.trend_data && node.trend_data.length > 0 && (
                          <div className="mt-4" style={{height: '200px'}}>
                            <canvas id={`chart-${node.name}`}></canvas>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                  )}
                </div>

                <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                  <div className="mb-4">
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center gap-2">
                        <Activity size={24} className="text-orange-600 dark:text-orange-400" />
                        <h2 className="text-xl font-bold text-gray-900 dark:text-white">Migration Recommendations</h2>
                        <button
                          onClick={() => toggleSection('recommendations')}
                          className="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                          title={collapsedSections.recommendations ? "Expand section" : "Collapse section"}
                        >
                          {collapsedSections.recommendations ? (
                            <ChevronDown size={20} className="text-gray-600 dark:text-gray-400" />
                          ) : (
                            <ChevronUp size={20} className="text-gray-600 dark:text-gray-400" />
                          )}
                        </button>
                      </div>
                      {recommendations.length > 0 && (
                        <button onClick={executeBatchMigration} disabled={loading} className="flex items-center gap-2 px-4 py-2 bg-green-600 dark:bg-green-500 text-white rounded hover:bg-green-700 dark:hover:bg-green-600 disabled:bg-gray-400">
                          <Play size={18} />
                          Migrate All ({recommendations.length})
                        </button>
                      )}
                    </div>
                    <div className="flex flex-wrap gap-4">
                      <div className="flex items-center gap-2">
                        <label className="text-sm font-medium text-gray-700 dark:text-gray-300">CPU Threshold:</label>
                        <input type="range" min="40" max="90" value={cpuThreshold} onChange={(e) => setCpuThreshold(Number(e.target.value))} className="w-32" />
                        <span className="text-sm font-semibold text-gray-900 dark:text-white">{cpuThreshold}%</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Memory Threshold:</label>
                        <input type="range" min="50" max="95" value={memThreshold} onChange={(e) => setMemThreshold(Number(e.target.value))} className="w-32" />
                        <span className="text-sm font-semibold text-gray-900 dark:text-white">{memThreshold}%</span>
                      </div>
                    </div>
                  </div>
                  {!collapsedSections.recommendations && (
                  <div className="transition-all duration-300 ease-in-out">
                  {recommendations.length === 0 ? (
                    <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                      <CheckCircle size={48} className="mx-auto mb-2 text-green-500 dark:text-green-400" />
                      <p className="font-medium">Cluster is balanced!</p>
                      <p className="text-sm">No migrations needed</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {recommendations.map((rec, idx) => {
                        const key = `${rec.vmid}-${rec.target_node}`;
                        const status = migrationStatus[key];
                        
                        return (
                          <div key={idx} className="border border-gray-200 dark:border-gray-700 rounded p-4">
                            <div className="flex items-center justify-between">
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-1">
                                  <span className="font-semibold text-gray-900 dark:text-white">[{rec.type} {rec.vmid}] {rec.name}</span>
                                  {status === 'success' && <CheckCircle size={18} className="text-green-600 dark:text-green-400" />}
                                  {status === 'failed' && <XCircle size={18} className="text-red-600 dark:text-red-400" />}
                                </div>
                                <div className="text-xs text-gray-500 dark:text-gray-500">
                                  <span className="text-red-600 dark:text-red-400 font-medium">FROM:</span> {rec.source_node} → <span className="text-green-600 dark:text-green-400 font-medium">TO:</span> {rec.target_node}
                                </div>
                                <div className="text-xs text-gray-500 dark:text-gray-500 mt-1">
                                  <span className="font-medium">Reason:</span> {rec.reason} | <span className="font-medium">Memory:</span> {(rec.mem_gb || 0).toFixed(1)} GB
                                </div>
                                <div className="text-xs font-mono bg-gray-100 dark:bg-gray-900 p-1 rounded mt-1 text-gray-700 dark:text-gray-300">{rec.command}</div>
                              </div>
                              <button 
                                onClick={() => executeMigration(rec)} 
                                disabled={status === 'running' || status === 'success'}
                                className="ml-4 px-4 py-2 bg-blue-600 dark:bg-blue-500 text-white rounded hover:bg-blue-700 dark:hover:bg-blue-600 disabled:bg-gray-400 flex items-center gap-2 shrink-0"
                              >
                                {status === 'running' ? (
                                  <>
                                    <RefreshCw size={16} className="animate-spin" />
                                    Starting...
                                  </>
                                ) : status === 'success' ? (
                                  <>
                                    <CheckCircle size={16} />
                                    Started
                                  </>
                                ) : status === 'failed' ? (
                                  <>
                                    <XCircle size={16} />
                                    Failed
                                  </>
                                ) : (
                                  <>
                                    <Play size={16} />
                                    Migrate
                                  </>
                                )}
                              </button>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                  </div>
                  )}
                </div>

                {config?.ai_recommendations_enabled && aiEnabled && (
                  <div className="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-2">
                        <h2 className="text-xl font-bold text-gray-900 dark:text-white">🤖 AI-Enhanced Recommendations</h2>
                        <button
                          onClick={() => toggleSection('aiRecommendations')}
                          className="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors"
                          title={collapsedSections.aiRecommendations ? "Expand section" : "Collapse section"}
                        >
                          {collapsedSections.aiRecommendations ? (
                            <ChevronDown size={20} className="text-gray-600 dark:text-gray-400" />
                          ) : (
                            <ChevronUp size={20} className="text-gray-600 dark:text-gray-400" />
                          )}
                        </button>
                      </div>
                      <div className="flex items-center gap-3">
                        <div className="flex items-center gap-2">
                          <label className="text-sm font-medium text-gray-700 dark:text-gray-300">Analysis Period:</label>
                          <select
                            value={aiAnalysisPeriod}
                            onChange={(e) => setAiAnalysisPeriod(e.target.value)}
                            className="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
                          >
                            <option value="1h">Last Hour</option>
                            <option value="6h">Last 6 Hours</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                          </select>
                        </div>
                        <button
                          onClick={fetchAiRecommendations}
                          disabled={loadingAi}
                          className="flex items-center gap-2 px-4 py-2 bg-purple-600 dark:bg-purple-500 text-white rounded hover:bg-purple-700 dark:hover:bg-purple-600 disabled:bg-gray-400"
                        >
                          {loadingAi ? (
                            <>
                              <RefreshCw size={18} className="animate-spin" />
                              Analyzing...
                            </>
                          ) : (
                            <>
                              <RefreshCw size={18} />
                              Get AI Analysis
                            </>
                          )}
                        </button>
                      </div>
                    </div>

                    {!collapsedSections.aiRecommendations && (
                    <div className="transition-all duration-300 ease-in-out">
                    {!aiRecommendations && !loadingAi && (
                      <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                        <Activity size={48} className="mx-auto mb-2" />
                        <p className="font-medium">AI Analysis Available</p>
                        <p className="text-sm">Click "Get AI Analysis" to receive AI-powered migration recommendations</p>
                      </div>
                    )}

                    {aiRecommendations && !aiRecommendations.success && (
                      <div className="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded p-4">
                        <div className="flex items-center gap-2 text-red-800 dark:text-red-200">
                          <AlertCircle size={20} />
                          <span className="font-medium">AI Analysis Error</span>
                        </div>
                        <p className="text-sm text-red-700 dark:text-red-300 mt-2">{aiRecommendations.error}</p>
                      </div>
                    )}

                    {aiRecommendations && aiRecommendations.success && (
                      <div className="space-y-4">
                        {aiRecommendations.analysis && (
                          <div className="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded p-4">
                            <div className="flex items-center gap-2 mb-2">
                              <Activity size={20} className="text-blue-600 dark:text-blue-400" />
                              <span className="font-medium text-blue-900 dark:text-blue-200">Cluster Analysis</span>
                            </div>
                            <p className="text-sm text-blue-800 dark:text-blue-200">{aiRecommendations.analysis}</p>
                          </div>
                        )}

                        {aiRecommendations.predicted_issues && aiRecommendations.predicted_issues.length > 0 && (
                          <div className="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 rounded p-4">
                            <div className="flex items-center gap-2 mb-2">
                              <AlertTriangle size={20} className="text-yellow-600 dark:text-yellow-400" />
                              <span className="font-medium text-yellow-900 dark:text-yellow-200">Predicted Issues</span>
                            </div>
                            <div className="space-y-2">
                              {aiRecommendations.predicted_issues.map((issue, idx) => (
                                <div key={idx} className="text-sm text-yellow-800 dark:text-yellow-200">
                                  <span className="font-medium">{issue.node}</span> - {issue.prediction}
                                  <span className="ml-2 text-xs">({((issue.confidence || 0) * 100).toFixed(0)}% confidence)</span>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}

                        {aiRecommendations.recommendations && aiRecommendations.recommendations.length === 0 && (
                          <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                            <CheckCircle size={48} className="mx-auto mb-2 text-green-500 dark:text-green-400" />
                            <p className="font-medium">No AI Recommendations</p>
                            <p className="text-sm">AI analysis found cluster is well-balanced</p>
                          </div>
                        )}

                        {aiRecommendations.recommendations && aiRecommendations.recommendations.filter(rec => rec.priority !== 'skipped').length > 0 && (
                          <div className="space-y-4">
                            {aiRecommendations.recommendations.filter(rec => rec.priority !== 'skipped').map((rec, idx) => {
                              const key = `ai-${rec.vmid}-${rec.target_node}`;
                              const status = migrationStatus[key];

                              const priorityColors = {
                                high: 'bg-red-100 dark:bg-red-900/30 border-red-300 dark:border-red-700 text-red-800 dark:text-red-200',
                                medium: 'bg-yellow-100 dark:bg-yellow-900/30 border-yellow-300 dark:border-yellow-700 text-yellow-800 dark:text-yellow-200',
                                low: 'bg-green-100 dark:bg-green-900/30 border-green-300 dark:border-green-700 text-green-800 dark:text-green-200'
                              };

                              const riskColor = rec.risk_score > 0.5 ? 'text-red-600 dark:text-red-400' :
                                               rec.risk_score > 0.2 ? 'text-yellow-600 dark:text-yellow-400' :
                                               'text-green-600 dark:text-green-400';

                              return (
                                <div key={idx} className={`border rounded-lg p-4 ${priorityColors[rec.priority] || priorityColors.medium}`}>
                                  <div className="flex items-start justify-between gap-4">
                                    <div className="flex-1">
                                      <div className="flex items-center gap-2 mb-2">
                                        <span className="font-bold text-lg">[{rec.type} {rec.vmid}] {rec.name}</span>
                                        <span className={`px-2 py-1 rounded text-xs font-bold uppercase ${
                                          rec.priority === 'high' ? 'bg-red-600 text-white' :
                                          rec.priority === 'medium' ? 'bg-yellow-600 text-white' :
                                          'bg-green-600 text-white'
                                        }`}>
                                          {rec.priority} Priority
                                        </span>
                                      </div>

                                      <div className="text-sm mb-2">
                                        <span className="font-semibold text-red-700 dark:text-red-300">FROM:</span> {rec.source_node}
                                        <span className="mx-2">→</span>
                                        <span className="font-semibold text-green-700 dark:text-green-300">TO:</span> {rec.target_node}
                                      </div>

                                      <div className="bg-white dark:bg-gray-800 rounded p-3 mb-2">
                                        <div className="flex items-start gap-2 mb-1">
                                          <Shield size={16} className="text-blue-600 dark:text-blue-400 mt-0.5" />
                                          <div className="flex-1">
                                            <span className="font-semibold text-sm">AI Reasoning:</span>
                                            <p className="text-sm mt-1">{rec.reasoning}</p>
                                          </div>
                                        </div>
                                      </div>

                                      <div className="flex items-center gap-2 text-xs mb-2">
                                        <AlertTriangle size={14} className={riskColor} />
                                        <span className="font-medium">Risk Score:</span>
                                        <span className={`font-bold ${riskColor}`}>{((rec.risk_score || 0) * 100).toFixed(0)}%</span>
                                      </div>

                                      {rec.estimated_impact && (
                                        <div className="bg-green-50 dark:bg-green-900/30 rounded p-2 text-xs">
                                          <span className="font-semibold">Expected Impact:</span> {rec.estimated_impact}
                                        </div>
                                      )}
                                    </div>

                                    <button
                                      onClick={() => {
                                        // Use the AI-specific key format
                                        const aiKey = `ai-${rec.vmid}-${rec.target_node}`;
                                        setMigrationStatus(prev => ({ ...prev, [aiKey]: 'running' }));

                                        fetch(`${API_BASE}/migrate`, {
                                          method: 'POST',
                                          headers: { 'Content-Type': 'application/json' },
                                          body: JSON.stringify({
                                            source_node: rec.source_node,
                                            vmid: rec.vmid,
                                            target_node: rec.target_node,
                                            type: rec.type
                                          })
                                        })
                                        .then(response => response.json())
                                        .then(result => {
                                          setMigrationStatus(prev => ({
                                            ...prev,
                                            [aiKey]: result.success ? 'success' : 'failed'
                                          }));
                                          if (result.success) {
                                            alert(`Migration started for ${rec.type} ${rec.vmid} (${rec.name || 'unnamed'}).\n\nCheck Proxmox cluster task logs for migration status and progress.`);
                                            setTimeout(() => fetchAnalysis(), 5000);
                                          }
                                        })
                                        .catch(() => {
                                          setMigrationStatus(prev => ({ ...prev, [aiKey]: 'failed' }));
                                        });
                                      }}
                                      disabled={status === 'running' || status === 'success'}
                                      className="px-4 py-2 bg-purple-600 dark:bg-purple-500 text-white rounded hover:bg-purple-700 dark:hover:bg-purple-600 disabled:bg-gray-400 flex items-center gap-2 shrink-0"
                                    >
                                      {status === 'running' ? (
                                        <>
                                          <RefreshCw size={16} className="animate-spin" />
                                          Starting...
                                        </>
                                      ) : status === 'success' ? (
                                        <>
                                          <CheckCircle size={16} />
                                          Started
                                        </>
                                      ) : status === 'failed' ? (
                                        <>
                                          <XCircle size={16} />
                                          Failed
                                        </>
                                      ) : (
                                        <>
                                          <Play size={16} />
                                          Migrate
                                        </>
                                      )}
                                    </button>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    )}
                    </div>
                    )}
                  </div>
                )}
              </div>
            </div>

            {showUpdateModal && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full p-6">
                  <div className="flex items-center justify-between mb-6">
                    <div className="flex items-center gap-2">
                      <RefreshCw size={24} className={updating ? "text-blue-600 dark:text-blue-400 animate-spin" : "text-blue-600 dark:text-blue-400"} />
                      <h2 className="text-xl font-bold text-gray-900 dark:text-white">Update ProxBalance</h2>
                    </div>
                    {!updating && (
                      <button
                        onClick={() => setShowUpdateModal(false)}
                        className="p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700"
                      >
                        <X size={20} className="text-gray-600 dark:text-gray-400" />
                      </button>
                    )}
                  </div>

                  {systemInfo && !updating && updateLog.length === 0 && (
                    <div className="space-y-4">
                      <div className="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded p-4">
                        <div className="flex items-start gap-3">
                          <div className="flex-shrink-0">
                            <RefreshCw size={24} className="text-blue-600 dark:text-blue-400" />
                          </div>
                          <div>
                            <h3 className="font-semibold text-blue-900 dark:text-blue-200 mb-2">Update Available</h3>
                            <div className="text-sm text-blue-800 dark:text-blue-300 space-y-1">
                              <p><span className="font-medium">Current Branch:</span> {systemInfo.branch}</p>
                              <p><span className="font-medium">Current Commit:</span> {systemInfo.commit}</p>
                              <p><span className="font-medium">Commits Behind:</span> {systemInfo.commits_behind}</p>
                              <p><span className="font-medium">Last Updated:</span> {systemInfo.last_commit_date}</p>
                            </div>
                          </div>
                        </div>
                      </div>

                      {systemInfo.changelog && systemInfo.changelog.length > 0 && (
                        <div className="bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded p-4">
                          <h3 className="font-semibold text-green-900 dark:text-green-200 mb-3 flex items-center gap-2">
                            <span>📋 What's New</span>
                            <span className="text-xs px-2 py-0.5 bg-green-200 dark:bg-green-800 rounded-full">
                              {systemInfo.changelog.length} update{systemInfo.changelog.length > 1 ? 's' : ''}
                            </span>
                          </h3>
                          <div className="space-y-2 max-h-48 overflow-y-auto">
                            {systemInfo.changelog.map((item, idx) => (
                              <div key={idx} className="flex items-start gap-2 text-sm">
                                <span className="text-green-600 dark:text-green-400 flex-shrink-0">●</span>
                                <div className="flex-1">
                                  <span className="text-green-900 dark:text-green-100">{item.message}</span>
                                  <span className="ml-2 text-xs font-mono text-green-600 dark:text-green-400">
                                    ({item.commit})
                                  </span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      <div className="bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 rounded p-4">
                        <div className="flex items-start gap-2">
                          <AlertTriangle size={20} className="text-yellow-600 dark:text-yellow-400 flex-shrink-0 mt-0.5" />
                          <div className="text-sm text-yellow-800 dark:text-yellow-300">
                            <p className="font-semibold mb-1">This will:</p>
                            <ul className="list-disc ml-4 space-y-1">
                              <li>Pull the latest code from branch: <span className="font-mono">{systemInfo.branch}</span></li>
                              <li>Update Python dependencies</li>
                              <li>Restart ProxBalance services</li>
                              <li>The page will automatically reload after update</li>
                            </ul>
                          </div>
                        </div>
                      </div>

                      <div className="flex gap-3">
                        <button
                          onClick={() => setShowUpdateModal(false)}
                          className="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-100 dark:hover:bg-gray-700"
                        >
                          Cancel
                        </button>
                        <button
                          onClick={handleUpdate}
                          className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 dark:bg-blue-500 text-white rounded hover:bg-blue-700 dark:hover:bg-blue-600"
                        >
                          <RefreshCw size={18} />
                          Update Now
                        </button>
                      </div>
                    </div>
                  )}

                  {(updating || updateLog.length > 0) && (
                    <div className="space-y-4">
                      <div className="bg-gray-50 dark:bg-gray-900 rounded-lg p-4 max-h-96 overflow-y-auto">
                        <div className="font-mono text-sm space-y-1">
                          {updateLog.map((line, idx) => (
                            <div key={idx} className="text-gray-800 dark:text-gray-200">
                              {line.includes('✓') ? (
                                <span className="text-green-600 dark:text-green-400">{line}</span>
                              ) : line.includes('Error') || line.includes('⚠') || line.includes('Failed') ? (
                                <span className="text-red-600 dark:text-red-400">{line}</span>
                              ) : line.includes('━') ? (
                                <span className="text-blue-600 dark:text-blue-400">{line}</span>
                              ) : (
                                <span>{line}</span>
                              )}
                            </div>
                          ))}
                          {updating && (
                            <div className="flex items-center gap-2 text-blue-600 dark:text-blue-400">
                              <RefreshCw size={16} className="animate-spin" />
                              <span>Updating...</span>
                            </div>
                          )}
                        </div>
                      </div>

                      {!updating && (
                        <div className="flex justify-end">
                          <button
                            onClick={() => {
                              setShowUpdateModal(false);
                              setUpdateLog([]);
                            }}
                            className="px-4 py-2 bg-blue-600 dark:bg-blue-500 text-white rounded hover:bg-blue-700 dark:hover:bg-blue-600"
                          >
                            Close
                          </button>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            )}

            {showBranchModal && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                  <div className="p-6">
                    <div className="flex items-center justify-between mb-6">
                      <div className="flex items-center gap-2">
                        <GitBranch size={24} className="text-purple-600 dark:text-purple-400" />
                        <h2 className="text-xl font-bold text-gray-900 dark:text-white">Switch Branch</h2>
                      </div>
                      <button
                        onClick={() => setShowBranchModal(false)}
                        className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                      >
                        <X size={24} />
                      </button>
                    </div>

                    {loadingBranches ? (
                      <div className="flex items-center justify-center py-8">
                        <RefreshCw size={24} className="animate-spin text-blue-600 dark:text-blue-400" />
                        <span className="ml-2 text-gray-600 dark:text-gray-400">Loading branches...</span>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        <div className="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded p-4">
                          <div className="flex items-start gap-2">
                            <AlertTriangle size={20} className="text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5" />
                            <div className="text-sm text-blue-800 dark:text-blue-300">
                              <p className="font-semibold mb-1">Switching branches will:</p>
                              <ul className="list-disc ml-4 space-y-1">
                                <li>Pull the latest code from the selected branch</li>
                                <li>Update dependencies if needed</li>
                                <li>Restart ProxBalance services</li>
                                <li>Reload the page automatically</li>
                              </ul>
                            </div>
                          </div>
                        </div>

                        <div className="space-y-2">
                          <h3 className="font-semibold text-gray-900 dark:text-white mb-3">Available Branches</h3>
                          {availableBranches.length === 0 ? (
                            <p className="text-gray-600 dark:text-gray-400 text-sm">No branches found</p>
                          ) : (
                            availableBranches.map((branch) => (
                              <div
                                key={branch.name}
                                className={`border rounded-lg p-4 ${
                                  branch.current
                                    ? 'border-purple-500 dark:border-purple-600 bg-purple-50 dark:bg-purple-900/20'
                                    : 'border-gray-200 dark:border-gray-700 hover:border-purple-300 dark:hover:border-purple-700'
                                }`}
                              >
                                <div className="flex items-center justify-between">
                                  <div className="flex-1">
                                    <div className="flex items-center gap-2">
                                      <GitBranch size={16} className={branch.current ? 'text-purple-600 dark:text-purple-400' : 'text-gray-500 dark:text-gray-400'} />
                                      <span className={`font-mono font-semibold ${
                                        branch.current
                                          ? 'text-purple-700 dark:text-purple-300'
                                          : 'text-gray-900 dark:text-white'
                                      }`}>
                                        {branch.name}
                                      </span>
                                      {branch.current && (
                                        <span className="px-2 py-0.5 bg-purple-600 dark:bg-purple-500 text-white text-xs rounded-full">
                                          Current
                                        </span>
                                      )}
                                    </div>
                                    {branch.last_commit && (
                                      <p className="text-xs text-gray-600 dark:text-gray-400 mt-1 ml-6">
                                        Latest: {branch.last_commit.substring(0, 50)}{branch.last_commit.length > 50 ? '...' : ''}
                                      </p>
                                    )}
                                  </div>
                                  {!branch.current && (
                                    <button
                                      onClick={() => switchBranch(branch.name)}
                                      disabled={switchingBranch}
                                      className="ml-4 px-4 py-2 bg-purple-600 dark:bg-purple-500 text-white rounded hover:bg-purple-700 dark:hover:bg-purple-600 disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                      {switchingBranch ? 'Switching...' : 'Switch'}
                                    </button>
                                  )}
                                </div>
                              </div>
                            ))
                          )}
                        </div>

                        <div className="flex justify-end pt-4">
                          <button
                            onClick={() => setShowBranchModal(false)}
                            className="px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-100 dark:hover:bg-gray-700"
                          >
                            Close
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {showSettings && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col my-8">
                  <div className="flex items-center justify-between p-6 pb-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
                    <div className="flex items-center gap-2">
                      <Settings size={24} className="text-blue-600 dark:text-blue-400" />
                      <h2 className="text-xl font-bold text-gray-900 dark:text-white">Settings</h2>
                    </div>
                    <button
                      onClick={() => setShowSettings(false)}
                      className="p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700"
                    >
                      <X size={20} className="text-gray-600 dark:text-gray-400" />
                    </button>
                  </div>

                  <div className="space-y-6 p-6 overflow-y-auto flex-1">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        Backend Collection Interval
                      </label>
                      <div className="flex items-center gap-4">
                        <input 
                          type="range" 
                          min="5" 
                          max="240" 
                          step="5"
                          value={tempBackendInterval}
                          onChange={(e) => setTempBackendInterval(Number(e.target.value))}
                          className="flex-1"
                        />
                        <span className="text-lg font-semibold text-gray-900 dark:text-white w-16 text-right">
                          {tempBackendInterval}m
                        </span>
                      </div>
                      <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                        How often to collect cluster data from Proxmox (5-240 minutes)
                      </p>
                    </div>

                    <div>
                      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        UI Refresh Interval
                      </label>
                      <div className="flex items-center gap-4">
                        <input 
                          type="range" 
                          min="5" 
                          max="120" 
                          step="5"
                          value={tempUiInterval}
                          onChange={(e) => setTempUiInterval(Number(e.target.value))}
                          className="flex-1"
                        />
                        <span className="text-lg font-semibold text-gray-900 dark:text-white w-16 text-right">
                          {tempUiInterval}m
                        </span>
                      </div>
                      <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                        How often the UI auto-refreshes (5-120 minutes)
                      </p>
                    </div>

                    <div className="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded p-3">
                      <p className="text-sm text-blue-900 dark:text-blue-200">
                        <strong>Recommendation:</strong> Set UI interval ≤ backend interval for best experience.
                        Current setup: UI refreshes every {tempUiInterval}m, data collected every {tempBackendInterval}m.
                      </p>
                    </div>

                    <hr className="border-gray-300 dark:border-gray-600" />

                    <div>
                      <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4">Proxmox API Configuration</h3>
                      <div className="space-y-4 p-4 bg-gray-50 dark:bg-gray-700/50 rounded">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            API Token ID
                          </label>
                          <input
                            type="text"
                            value={proxmoxTokenId}
                            onChange={(e) => setProxmoxTokenId(e.target.value)}
                            placeholder="root@pam!proxbalance"
                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono text-sm"
                          />
                          <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            Format: user@realm!tokenname (e.g., root@pam!proxbalance)
                          </p>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            API Token Secret
                          </label>
                          <input
                            type="password"
                            value={proxmoxTokenSecret}
                            onChange={(e) => setProxmoxTokenSecret(e.target.value)}
                            placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono text-sm"
                          />
                          <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                            The UUID token secret from Proxmox
                          </p>
                        </div>
                        <div className="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded p-3">
                          <p className="text-sm text-blue-900 dark:text-blue-200">
                            <strong>Tip:</strong> Use the installation script to automatically create an API token with proper permissions.
                          </p>
                        </div>
                      </div>
                    </div>

                    <hr className="border-gray-300 dark:border-gray-600" />

                    <div>
                      <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        AI-Powered Recommendations
                      </label>
                      <div className="flex items-center mb-4">
                        <input
                          type="checkbox"
                          checked={aiEnabled}
                          onChange={(e) => setAiEnabled(e.target.checked)}
                          className="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                        />
                        <label className="ml-2 text-sm text-gray-700 dark:text-gray-300">
                          Enable AI-Enhanced Migration Recommendations
                        </label>
                      </div>
                    </div>

                    {aiEnabled && (
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            AI Provider
                          </label>
                          <select
                            value={aiProvider}
                            onChange={(e) => setAiProvider(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                          >
                            <option value="none">None</option>
                            <option value="openai">OpenAI (GPT-4)</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="local">Local LLM (Ollama)</option>
                          </select>
                        </div>

                        {aiProvider === 'openai' && (
                          <div className="space-y-3 p-4 bg-gray-50 dark:bg-gray-700/50 rounded">
                            <h4 className="font-medium text-gray-900 dark:text-white">OpenAI Configuration</h4>
                            <div>
                              <label className="block text-sm text-gray-700 dark:text-gray-300 mb-1">
                                API Key
                              </label>
                              <input
                                type="password"
                                value={openaiKey}
                                onChange={(e) => setOpenaiKey(e.target.value)}
                                placeholder="sk-..."
                                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                              />
                            </div>
                            <div>
                              <div className="flex items-center justify-between mb-1">
                                <label className="block text-sm text-gray-700 dark:text-gray-300">
                                  Model Name
                                </label>
                                <button
                                  onClick={() => fetchAiModels('openai', openaiKey)}
                                  disabled={!openaiKey || openaiLoadingModels}
                                  className="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400"
                                >
                                  {openaiLoadingModels ? 'Loading...' : 'Refresh Models'}
                                </button>
                              </div>
                              {openaiAvailableModels.length > 0 ? (
                                <>
                                  <select
                                    value={openaiModel}
                                    onChange={(e) => setOpenaiModel(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                  >
                                    {openaiAvailableModels.map(model => (
                                      <option key={model} value={model}>{model}</option>
                                    ))}
                                  </select>
                                  <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    Select from available models or enter custom name below
                                  </p>
                                  <input
                                    type="text"
                                    value={openaiModelCustom}
                                    onChange={(e) => setOpenaiModelCustom(e.target.value)}
                                    placeholder="Or enter custom model (e.g., gpt-4o-mini, o1-preview)"
                                    className="w-full px-3 py-2 mt-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono text-sm"
                                  />
                                </>
                              ) : (
                                <>
                                  <input
                                    type="text"
                                    value={openaiModel}
                                    onChange={(e) => setOpenaiModel(e.target.value)}
                                    placeholder="gpt-4o"
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono text-sm"
                                  />
                                  <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    <a href="https://platform.openai.com/docs/models" target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline">
                                      View available models
                                    </a>
                                    {' '}- Enter model name or click "Refresh Models" to fetch from API
                                  </p>
                                </>
                              )}
                            </div>
                          </div>
                        )}

                        {aiProvider === 'anthropic' && (
                          <div className="space-y-3 p-4 bg-gray-50 dark:bg-gray-700/50 rounded">
                            <h4 className="font-medium text-gray-900 dark:text-white">Anthropic Configuration</h4>
                            <div>
                              <label className="block text-sm text-gray-700 dark:text-gray-300 mb-1">
                                API Key
                              </label>
                              <input
                                type="password"
                                value={anthropicKey}
                                onChange={(e) => setAnthropicKey(e.target.value)}
                                placeholder="sk-ant-..."
                                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                              />
                            </div>
                            <div>
                              <label className="block text-sm text-gray-700 dark:text-gray-300 mb-1">
                                Model Name
                              </label>
                              <input
                                type="text"
                                value={anthropicModel}
                                onChange={(e) => setAnthropicModel(e.target.value)}
                                placeholder="claude-sonnet-4-5-20250929"
                                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono text-sm"
                              />
                              <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                <a href="https://docs.claude.com/en/docs/about-claude/models" target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline">
                                  View available models
                                </a>
                                {' '}- Current: claude-sonnet-4-5-20250929, claude-haiku-4-5-20251001
                              </p>
                            </div>
                          </div>
                        )}

                        {aiProvider === 'local' && (
                          <div className="space-y-3 p-4 bg-gray-50 dark:bg-gray-700/50 rounded">
                            <h4 className="font-medium text-gray-900 dark:text-white">Local LLM Configuration (Ollama)</h4>
                            <div>
                              <label className="block text-sm text-gray-700 dark:text-gray-300 mb-1">
                                Base URL
                              </label>
                              <input
                                type="text"
                                value={localUrl}
                                onChange={(e) => setLocalUrl(e.target.value)}
                                placeholder="http://localhost:11434"
                                className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                              />
                            </div>
                            <div>
                              <div className="flex items-center justify-between mb-1">
                                <label className="block text-sm text-gray-700 dark:text-gray-300">
                                  Model Name
                                </label>
                                <button
                                  onClick={() => fetchAiModels('local', null, localUrl)}
                                  disabled={localLoadingModels}
                                  className="text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400"
                                >
                                  {localLoadingModels ? 'Loading...' : 'Refresh Models'}
                                </button>
                              </div>
                              {localAvailableModels.length > 0 ? (
                                <>
                                  <select
                                    value={localModel}
                                    onChange={(e) => setLocalModel(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                  >
                                    {localAvailableModels.map(model => (
                                      <option key={model} value={model}>{model}</option>
                                    ))}
                                  </select>
                                  <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    Select from installed models or enter custom name below
                                  </p>
                                  <input
                                    type="text"
                                    value={localModelCustom}
                                    onChange={(e) => setLocalModelCustom(e.target.value)}
                                    placeholder="Or enter custom model (e.g., llama2, mistral, codellama)"
                                    className="w-full px-3 py-2 mt-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono text-sm"
                                  />
                                </>
                              ) : (
                                <>
                                  <input
                                    type="text"
                                    value={localModel}
                                    onChange={(e) => setLocalModel(e.target.value)}
                                    placeholder="llama2"
                                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white font-mono text-sm"
                                  />
                                  <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    <a href="https://ollama.com/library" target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline">
                                      Browse Ollama models
                                    </a>
                                    {' '}- Enter model name or click "Refresh Models" to list installed models
                                  </p>
                                </>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>

                  <div className="flex gap-3 p-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
                    <button
                      onClick={() => setShowSettings(false)}
                      className="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-100 dark:hover:bg-gray-700"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={saveSettings}
                      disabled={savingSettings}
                      className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 dark:bg-blue-500 text-white rounded hover:bg-blue-700 dark:hover:bg-blue-600 disabled:bg-gray-400"
                    >
                      <Save size={18} />
                      {savingSettings ? 'Saving...' : 'Save Settings'}
                    </button>
                  </div>
                </div>
              </div>
            )}
        </>);
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<ProxmoxBalanceManager />);
  </script>
</body>
</html>
